#include <Arduino.h>
#ifdef ESP8266
#include <ESP8266WiFi.h>
#endif
#ifdef ESP32
#include <WiFi.h>
#endif

class GuineapigWiFiConfig
{
public:
    GuineapigWiFiConfig() = default;
    bool connectWiFi();
    typedef void (*LogCallback)(String);    
    LogCallback logCallback;
    void clearWiFiConfig();

private:
    void printLog(String msg);
    void printlnLog(String msg) { printLog(msg + "\n"); }
    void printlnLog() { printlnLog(""); }
    bool tryConnect();
    void initConfigWeb();   
};

extern GuineapigWiFiConfig WiFiConfig;

const char guineapig_wifi_config_html[] PROGMEM = R"====(
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <style>
        .content { width: 240px; margin: 0 auto; font-size: 16pt; font-family: '微軟正黑體' }
        form > * { width: 95%; margin: 6px auto;  }
        #dvStatus { font-size: 14pt; color: dodgerblue; }
    </style>
</head>
<body>
<div class=content>
    <div style='text-align:center'>無線網路設定<div>
    <form action="/" method="POST" target='submitRes'>
    <input name="ssid" placeholder="SSID" />
    <input type="password" name="passwd" placeholder="請輸入密碼" />
    <input type="submit" name="action" value="儲存設定" id=btnSave />
    <input type="submit" name="action" value="重新啟動" disabled id=btnReboot />
    </form>
    <iframe name='submitRes' style='display:none'></iframe>
    <div id=dvStatus></div>
</div>
<script>
var xhr = new XMLHttpRequest();
xhr.addEventListener("load", function() {
    var res = JSON.parse(this.responseText);
    document.getElementById('dvStatus').innerHTML = res.m;
    if (res.p == "CONNECTED") {
        document.getElementById('btnSave').disabled = true;
        document.getElementById('btnReboot').disabled = false;
    }
    else if (res.p == "REBOOT") {
        clearInterval(hnd);
    }
});
var hnd = setInterval(function() { 
    xhr.open("GET", "http://" + location.host + "/status");
    xhr.send(); 
}, 1000);
</script>
</body></html>
)====";

const unsigned char guineapig_logo[] PROGMEM{
    // 'Guienapig-BW', 64x64px
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0x0f, 0xff, 0xff, 0xff, 0xfb, 0xff, 0xff, 0xf8, 0x0f, 0xff, 0xc1, 0xff, 0xf1, 0x1f, 0xff, 0xf8,
    0x0f, 0xff, 0x00, 0xff, 0xf4, 0x5f, 0xff, 0xf8, 0x0f, 0xfc, 0x2a, 0x1f, 0xe2, 0x0f, 0xff, 0xf8,
    0x0f, 0xf1, 0x55, 0x43, 0xe5, 0x0f, 0xff, 0xf8, 0x0f, 0xe2, 0xaa, 0xa8, 0x0a, 0x8f, 0xff, 0xf8,
    0x0f, 0xc5, 0x55, 0x55, 0x55, 0x47, 0xff, 0xf8, 0x0f, 0x8a, 0xaa, 0xaa, 0xaa, 0xa1, 0xff, 0xf8,
    0x0f, 0x95, 0x54, 0x55, 0x55, 0x54, 0x7f, 0xf8, 0x0f, 0x2a, 0xa9, 0x0a, 0xaa, 0xaa, 0x3f, 0xf8,
    0x0f, 0x55, 0x51, 0xc5, 0x55, 0x45, 0x1f, 0xf8, 0x0e, 0x2a, 0xab, 0xf2, 0xaa, 0xa2, 0x8f, 0xf8,
    0x0e, 0x55, 0x53, 0xf5, 0x55, 0x51, 0x4f, 0xf8, 0x0e, 0xaa, 0xa7, 0xf2, 0xaa, 0xaa, 0xa0, 0x78,
    0x0e, 0x55, 0x4f, 0xf9, 0x55, 0x55, 0x50, 0x38, 0x0e, 0xaa, 0x9f, 0xf8, 0xaa, 0xaa, 0xa1, 0xf8,
    0x0e, 0x55, 0x3f, 0xfc, 0x55, 0x55, 0x00, 0x78, 0x0c, 0xaa, 0x7f, 0xff, 0x2a, 0xa0, 0x07, 0x78,
    0x0c, 0x50, 0xff, 0xff, 0x90, 0x0f, 0xc3, 0xf8, 0x0c, 0x03, 0xff, 0xff, 0x83, 0xff, 0x83, 0xf8,
    0x0c, 0x7f, 0xff, 0xff, 0xc7, 0xfc, 0x19, 0xc8, 0x0c, 0x7f, 0xff, 0xff, 0xff, 0xf0, 0x7b, 0x88,
    0x0e, 0x7f, 0xff, 0xff, 0xff, 0xc3, 0xfe, 0x18, 0x0e, 0x7f, 0xff, 0xf7, 0xf8, 0x09, 0x80, 0x18,
    0x0e, 0x7f, 0xff, 0xe3, 0xfc, 0x24, 0x80, 0x98, 0x0f, 0x3f, 0xfc, 0x01, 0xff, 0x01, 0x01, 0x38,
    0x0f, 0x00, 0x00, 0x00, 0x7f, 0x83, 0x01, 0x38, 0x0f, 0x90, 0x03, 0xfe, 0x1f, 0xd2, 0x02, 0x78,
    0x0f, 0xab, 0xff, 0xff, 0x81, 0xca, 0x00, 0x78, 0x0f, 0x93, 0xff, 0xff, 0xe0, 0x10, 0x01, 0xf8,
    0x0f, 0xc7, 0xff, 0xff, 0xff, 0x00, 0x03, 0xf8, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xe7, 0x07, 0xf8,
    0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x03, 0x00, 0xc0, 0x00, 0x00, 0xc0,
    0x00, 0x20, 0x01, 0x00, 0x40, 0x00, 0x00, 0x40, 0x00, 0x20, 0x01, 0x04, 0x40, 0x00, 0x00, 0x40,
    0x01, 0xe7, 0x2d, 0x2f, 0x79, 0x6e, 0x73, 0xc0, 0x01, 0x21, 0x35, 0x44, 0x49, 0xa9, 0x12, 0x40,
    0x03, 0x27, 0x21, 0xc4, 0x49, 0x1f, 0x76, 0x40, 0x01, 0x2d, 0x21, 0x64, 0x49, 0x08, 0xd2, 0x40,
    0x01, 0xf7, 0xb3, 0xb6, 0xcd, 0x8e, 0x7b, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};